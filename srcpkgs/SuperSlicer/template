# Template file for 'SuperSlicer'
pkgname=SuperSlicer
version=2.4.58.5
revision=1
build_style=cmake
build_helper="qemu cmake-wxWidgets-gtk3"
configure_args="-DSLIC3R_WX_STABLE=1 -DSLIC3R_FHS=ON -DSLIC3R_GTK=3
 -DSLIC3R_ENC_CHECK=0 -DUSE_BLOSC=ON -DUSE_EXR=ON -DSLIC3R_ALPHA=OFF
 -DCMAKE_BUILD_TYPE=Release"
hostmakedepends="pkg-config"
makedepends="boost-devel cereal cgal-devel dbus-devel eigen glew-devel
 glu-devel gmpxx-devel gtest-devel gtk+3-devel libcurl-devel libglib-devel
 libpng-devel nlopt-devel openvdb-devel tbb-devel wxWidgets-devel
 c-blosc-devel ilmbase-devel libopenexr-devel wxWidgets-gtk3-devel"
short_desc="G-code generator for 3D printers (RepRap, Makerbot, Ultimaker etc.)"
maintainer="Danielle Hutzley <endergeryt@gmail.com>"
license="AGPL-3.0-or-later"
homepage="https://github.com/supermerill/SuperSlicer"
distfiles="https://github.com/supermerill/SuperSlicer/archive/refs/tags/${version}.tar.gz
 https://github.com/slic3r/slic3r-profiles/archive/refs/heads/main.tar.gz"
checksum="6bfb4198ff009cf1c5109ceb994fc2a701c6add35b5237abb2aec8b561214821
 a1fb0ce0133346f22e71b38072506642d0c3205fc19b9365d4a39876dee15a33"

post_extract() {
	# Move profiles to resources
	mv ../slic3r-profiles-*/* resources/profiles/

	# Mark tests that fail on certain targets
	case "$XBPS_TARGET_MACHINE" in
		*-musl)
			vsed -i tests/libslic3r/test_mutable_priority_queue.cpp \
			-e 's/\(TEST_CASE("Mutable priority queue - first pop", "\[MutableSkipHeapPriorityQueue\]\)\(")\)/\1[!mayfail]\2/'
			;;
		i686*)
			vsed -i tests/libslic3r/test_voronoi.cpp \
			-e 's/\(TEST_CASE("Voronoi offset 2", "\[VoronoiOffset\]\)\(")\)/\1[!mayfail]\2/'
			vsed -i tests/fff_print/test_trianglemesh.cpp \
			-e 's/\(SCENARIO( "make_xxx functions produce meshes."\)\()\)/\1, "[!mayfail]"\2/'
			;;
	esac
}

post_install() {
	vinstall ${FILESDIR}/SuperSlicer.desktop 644 usr/share/applications
	vlicense LICENSE
}
